<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">


<head>
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript"></script>

    <style type="text/css">
        .subjtext {
            font-size: 12px;
            font-family: "Gill Sans", "Lucida Grande", Lucida, Verdana, sans-serif;
            color: #000000;
        }

        ul#gallery {
            margin: 0 auto;
            padding: 0;
            list-style-type: none;
            width: 100%;
        }

        ul#gallery li {
            float: left;
            margin: 5px;
            background-color: gray;
        }

        body {
            background-color: #404040;
            font-family: "Gill Sans", "Lucida Grande", Lucida, Verdana, sans-serif;
            color: #FFFFFF;
        }

        p {
            text-align: left;
            color: #CCCCCC;
        }

        ul#gallery li p {
            margin: 5px 5px;
            text-align: left;
            color: black;
        }

        .roundrect {
            margin: 5px;
            padding: 5px;
            border: 2px solid;
            border-radius: 5px;
        }

        .progressbar {
            background-color: black;
            border-radius: 6px; /* (height of inner div) / 2 + padding */
            padding: 3px;
        }

        .progressbar > div {
            background-color: #B0B0B0;
            padding: 0px;
            width: 0%; /* Adjust with JavaScript */
            height: 6px;
            border-radius: 3px;
        }
        #images  {
            overflow-y:scroll;
            height:400px;
        }
        #slider_thumbsize {
            height: 15px;
            width:75%;
            float:right;
        }
        #slider_showstage {
            height: 15px;
            width:75%;
            float:right;
        }

    </style>

    <title>BrainSuite Surface Extraction & Labeling</title>






    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////-->
    <script type="text/javascript">
        var JSON_PATH= "/Data/brainsuite_state.json";
        var DATA_PATH= "/Data/";
        const PROCESS_NAMES= ["initialization", "skull-stripping", "bias-correction", "tissue labeling",
                          "cerebrum masking", "initial cortex masking", "mask scrubbing",
                          "topology correction", "inner cortex mask generation", "inner cortical surface generation",
                  "pial cortex", "hemisphere splitting. Processing complete."]; //"labeled cortex"];

        const SHORT_NAMES = ["mri", "skull-stripped", "bias-corrected", "tissue labels", "cerebrum mask",
                 "initial cortex mask", "scrubbed cortex", "topo-corrected", "inner cortex mask",
                 "inner cortex", "pial cortex", "hemisphere split"]; //"labeled cortex"];

        const STEP_NAMES = [".png", ".bse.png", ".bfc.png", ".pvc.label.png", ".cerebrum.png", ".init.cortex.png",
                ".cortex.scrubbed.png", ".cortex.tca.png", ".cortex.dewisp.png", ".inner.cortex.png",
                ".pial.cortex.png", ".left.png"];


        var selectedSubjectIndex = 0;
        var ajaxLock = false;
        var pathToThumbnails;
        var subjects = []; //Init subjects from JSON
        var subjectStates = []; //Init from JSON. All initially -1

        function initPaths(){
            var baseURL = document.URL.toString();
            baseURL = baseURL.substring(0, baseURL.lastIndexOf("/"));
            JSON_PATH = baseURL + JSON_PATH;
            DATA_PATH = baseURL + DATA_PATH;
        }

        function initFromJSON(){
            $.ajax({
                cache: false,
                url: JSON_PATH,
                dataType: "json",
                success: function (json) {
                    ajaxLock = true;
                    if (json) {
                        //TODO: Checking for null
                        var statusString = "Initializing data from file: " + JSON_PATH;
                        if (json.subjects) {
                            setStatus(statusString);
                            pathToThumbnails = json.path_to_thumbnails;
                            //Init arrays
                            for(var i = 0 ; i < Object(json.subjects).length; i++){
                                subjects.push(json.subjects[i].name);
                                subjectStates.push(-1);
                            }

                            initGallery();

                        }
                        else {
                            setStatus(statusString + " (no state data available)");
                        }
                    }

                    ajaxLock = false;
                }
            });

        }

        function initGallery(){
            var galleryHTML = "";
            for(var i = 0 ; i < subjects.length ; i++){
                galleryHTML +=
                    `<li id="li${i}" style="border:2px solid black;">
                        <img id="img${i}" height="128px" onclick="loadSubjTray(${i})" />
                        <div class="subjtext" id="text${i}">${subjects[i]}<br>Initializing</div>
                        <div class="progressbar">
                            <div id="progress${i}"></div>
                        </div>
                    </li>
                    `
            }
        $("#gallery").html(galleryHTML);
        }


        /**
         *
         * @param id Pass in INDEX of selected subject
         */
        function loadSubjTray(subjectIndex) {
            selectedSubjectIndex = subjectIndex;

            //Handle border highlight
            for (var sid = 0; sid < subjects.length; sid++) {
                var lid = document.getElementById("li" + sid);
                if (subjectIndex == sid) {
                    lid.style.borderColor = "#000080";
                }
                else{
                    lid.style.borderColor = "#000000";
                }
            }

            var subjID = subjects[subjectIndex];
            var subjectState = parseInt(subjectStates[subjectIndex]);
            var statusString = "<p>ID: " + subjID + "<br/>status:";
            if (subjectState < 0){
                //Invalid state, or init state
                subjectState = 0;
            } else {
                statusString += " finished " + PROCESS_NAMES[subjectState];
                if ( (subjectState + 1) < PROCESS_NAMES.length) {
                    statusString += ", performing " + PROCESS_NAMES[subjectState + 1];
                }
            }

            statusString += "</p>";
            for (var i = 0; i <= subjectState; i++) {
                statusString += "<img src='" + makeURL(subjectIndex, i) + "' title='" + SHORT_NAMES[i] + "' width=" + (100 * 1 / PROCESS_NAMES.length) + "%>";
            }
            $("#tray").html(statusString);
        }


        function setStatus(statusString) {
            $("#status").html(statusString);
        }

        function setMessage(messageString) {
            $("#message").html(messageString);
        }

        function displayImage(image, id) {
            document.getElementById("img" + id).src = image;
        }

        function urlExists(testUrl) { // this will return 200 on success, and 0 or negative value on error
            var http = jQuery.ajax({
                type: "HEAD",
                url: testUrl,
                async: false
            });
            return http.status;
        }


        function makeURL(subjectIndex, state) {
            if (state < 0){
                state = 0;
            }
            if (!STEP_NAMES[state]){
                return null;
            }
            return DATA_PATH + subjects[subjectIndex] + pathToThumbnails + subjects[subjectIndex] + STEP_NAMES[state];
        }



        function setThumbSize(height) {
            for (var subjectIndex = 0; subjectIndex < subjects.length; subjectIndex++) {
                $("#img" + subjectIndex).attr("height", height);


            }
            $("#thumbsize").html(height);
        }

        function setShowStage(stage){
            $("#showstage").html(SHORT_NAMES[stage]);
        }

        function updateImages(newStates) {
            loadSubjTray(selectedSubjectIndex);

            for (var subjectIndex = 0; subjectIndex < subjects.length; subjectIndex++) {
                {
                    var newState = parseInt(newStates[subjectIndex].state);
                    if (newState != subjectStates[subjectIndex]) {
                        var url = makeURL(subjectIndex, newState);
                        if (!url){
                            continue;
                        }
                        var check = urlExists(url);
                        if (check == 200) {
                            var statePct = 0;
                            if (newState > 0) {
                                statePct = newState / (SHORT_NAMES.length - 1);
                            }
                            if (statePct > 1){
                                statePct = 1;
                            }
                            document.getElementById("progress" + subjectIndex).style.width = 100 * statePct + "%";
                            document.getElementById("text" + subjectIndex).innerHTML = subjects[subjectIndex] + "<br/>" + SHORT_NAMES[newState];
                            displayImage(makeURL(subjectIndex, newState), subjectIndex);

                            subjectStates[subjectIndex] = newState;
                        }
                    }
                }
            }
        }


        function scanJSON() {
            if (ajaxLock){
                return;
            }

            $.ajax({
                cache: false,
                url: JSON_PATH,
                dataType: "json",
                success: function (json) {
                    ajaxLock = true;

                    if (json) {
                        var statusString = json.status;
                        statusString += "started at: " + json.start_time;
                        statusString += "<br/>runtime: " + json.runtime;
                        if (json.subjects) {
                            setStatus(statusString);
                            updateImages(json.subjects);
                        }
                        else {
                            setStatus(statusString + " (no state data available)");
                        }
                    }

                    ajaxLock = false;
                }
            });
        }

        function startTimer() {
            setInterval(scanJSON, 1000);
            setStatus("initializing images");
        }

        $(document).ready(function(){

            $(function () {
                $("#slider_thumbsize").slider({
                    slide: function (event, ui) {
                        setThumbSize(ui.value);
                    },
                    animate: "fast", min: 64, max: 512, value: 128
                });
 
            $(function () {
                $("#slider_showstage").slider({
                    slide: function (event, ui) {
                        setShowStage(ui.value);
                    },
                    animate: "fast", min:0 , max: PROCESS_NAMES.length - 1, value: PROCESS_NAMES.length - 1
                });
            });
           });

            $(window).resize(function () {
                var viewportWidth = $(window).width();
                var viewPortHeight = $(window).height();
                var imageport = document.getElementById("images");
                if (imageport)
                    imageport.style.height = (viewPortHeight - 400) + "px";
            });
            initPaths();
            initFromJSON();
            $("#slider_thumbsize").slider().trigger("slide");
            startTimer();
        });
    </script>
    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////-->

</head>


<body>
    <div>
        <div class="roundrect" style="margin-right:px;">
            <center style="font-size:150%">BrainSuite QC System</center>
            <div style="width:70%">
            <p id="status">initializing</p>
                <span>Thumbnail Size</span>
                <span id="thumbsize"></span>
                <div id="slider_thumbsize"></div>
            </div>
            <div style="width:70%">
                <span>Show Stage</span>
                <span id="showstage"></span>
                <div id = "slider_showstage"></div>
            </div>
        </div>

        <div id="tray" class="roundrect" style="margin-right:px"></div>
        <div id="images" class="roundrect">
            <ul id="gallery">
                <!-- Dynamically init from initFromJSON() -->
            </ul>
        </div> <!-- images frame -->
    </div>
</body>

