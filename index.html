<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">


<head>
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript"></script>

    <style type="text/css">
        .subjtext {
            font-size: 12px;
            font-family: "Gill Sans", "Lucida Grande", Lucida, Verdana, sans-serif;
            color: #000000;
        }

        ul#gallery {
            margin: 0 auto;
            padding: 0;
            list-style-type: none;
            width: 100%;
        }

        ul#gallery li {
            float: left;
            margin: 5px;
            background-color: gray;
        }

        body {
            background-color: #404040;
            font-family: "Gill Sans", "Lucida Grande", Lucida, Verdana, sans-serif;
            color: #FFFFFF;
        }

        p {
            text-align: left;
            color: #CCCCCC;
        }

        ul#gallery li p {
            margin: 5px 5px;
            text-align: left;
            color: black;
        }

        .roundrect {
            margin: 5px;
            padding: 5px;
            border: 2px solid;
            border-radius: 5px;
        }

        .progressbar {
            background-color: black;
            border-radius: 6px; /* (height of inner div) / 2 + padding */
            padding: 3px;
        }

        .progressCompleted {
            background-color: #B0B0B0;
            padding: 0px;
            width: 0%; /* Adjust with JavaScript */
            height: 6px;
            border-radius: 2px;
            padding: 0.5px;
        }

        .progressShown {
            background-color: #000080;
            padding: 0px;
            vertical-align: middle;
            height: 5px;
            width: 0%; /* Adjust with JavaScript */
            border-radius: 3px;
        }

        #images  {
            overflow-y:scroll;
            height:400px;
        }
        #slider_thumbsize {
            height: 15px;
            width:60%;
            float:right;
        }
        #slider_showstage {
            height: 15px;
            width:60%;
            float:right;
        }

    </style>

    <title>BrainSuite Surface Extraction & Labeling</title>






    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////-->
    <script type="text/javascript">
        var BASE_URL = "";
        var JSON_PATH = "/brainsuite_state.json";
        const PROCESS_NAMES = 
            ["initialization", "skull-stripping", "bias-correction", "tissue labeling",
             "cerebrum masking", "initial cortex masking", "mask scrubbing",
             "topology correction", "inner cortex mask generation", "inner cortical surface generation",
             "pial cortex", "hemisphere splitting"]; //"labeled cortex"];


        const SHORT_NAMES =
            ["mri", "skull-stripped", "bias-corrected", "tissue labels", "cerebrum mask",
             "initial cortex mask", "scrubbed cortex", "topo-corrected", "inner cortex mask",
             "inner cortex", "pial cortex", "hemisphere split"]; //"labeled cortex"];

        const THUMBNAIL_SUFFIX =
            [".png", ".bse.png", ".bfc.png", ".pvc.label.png", ".cerebrum.png", ".init.cortex.png",
             ".cortex.scrubbed.png", ".cortex.tca.png", ".cortex.dewisp.png", ".inner.cortex.png",
             ".pial.cortex.png", ".left.png"];
        
        const STATS_SUFFIX =
            ["-mri.txt", "-bse.txt", "-bfc.txt", "-pvc.txt", "-cerebro.txt", "-cortex.txt",
             "-scrubmask.txt", "-tca.txt", "-dewisp.txt", "-dfs.txt", "-pialmesh.txt",
             "-hemisplit.txt"];
        
        const DEFAULT_THUMB_SIZE = 128;
        const DEFAULT_SHOWSTAGE = PROCESS_NAMES.length - 1

        var selectedSubjectIndex = 0;
        var ajaxLock = false;
        var THUMBNAILS_ABSPATH;
        var THUMBNAILS_RELATIVEPATH;
        var STATS_ABSPATH;
        var STATS_RELATIVEPATH;
        var subjects = []; //Init subjects from JSON
        var subjectStates = []; //Init from JSON. All initially -1

        function initPaths(){
            var docURL = document.URL.toString();
            BASE_URL = docURL.substring(0, docURL.lastIndexOf("/"));
            JSON_PATH = BASE_URL + JSON_PATH;
        }

        function initFromJSON(){
            $.ajax({
                cache: false,
                url: JSON_PATH,
                dataType: "json",
                success: function (json) {
                    ajaxLock = true;
                    if (json) {
                        //TODO: Checking for null
                        var statusString = "Initializing data from file: " + JSON_PATH;
                        if (json.subjects) {
                            setStatus(statusString);
                            THUMBNAILS_ABSPATH = json.thumbnails_abspath;
                            THUMBNAILS_RELATIVEPATH = BASE_URL + json.thumbnails_relativepath;
                            STATS_ABSPATH = json.stats_abspath;
                            STATS_RELATIVEPATH = BASE_URL + json.stats_relativepath;
                            //Init arrays
                            for(var i = 0 ; i < Object(json.subjects).length; i++){
                                subjects.push(json.subjects[i].name);
                                subjectStates.push(-1);
                            }
                            setSubjectCount(subjects.length);
                            setShowStage(DEFAULT_SHOWSTAGE);
                            setThumbSize(DEFAULT_THUMB_SIZE);
                            initGallery();

                        }
                        else {
                            setStatus(statusString + " (no state data available)");
                        }
                    }

                    ajaxLock = false;
                }
            });

        }

        function initGallery(){
            var galleryHTML = "";
            for(var i = 0 ; i < subjects.length ; i++){
                galleryHTML +=
                    `<li id="li${i}" style="border:2px solid black;">
                        <img id="img${i}" height="128px" style="cursor: pointer;" onclick="loadSubjTray(${i})" />
                        <div class="subjtext" id="text${i}">${subjects[i]}<br>Initializing</div>
                        <div class="progressbar">
                            <div class="progressCompleted" id="progress${i}">
                                <div class="progressShown" id="progressShown${i}"></div>
                            </div>
                        </div>
                    </li>
                    `
            }
        $("#gallery").html(galleryHTML);
        }


        /**
         *
         * @param id Pass in INDEX of selected subject
         */
        function loadSubjTray(subjectIndex) {
            selectedSubjectIndex = subjectIndex;

            //Handle border highlight
            for (var sid = 0; sid < subjects.length; sid++) {
                var lid = document.getElementById("li" + sid);
                if (subjectIndex == sid) {
                    lid.style.borderColor = "#000080";
                }
                else{
                    lid.style.borderColor = "#000000";
                }
            }

            var subjID = subjects[subjectIndex];
            var subjectState = parseInt(subjectStates[subjectIndex]);
            var statusString = "<p>ID: " + subjID + "<br/>status:";
            if (subjectState < 0){
                //Invalid state, or init state
                subjectState = 0;
            } else {
                statusString += " finished " + PROCESS_NAMES[subjectState];
                if ( (subjectState + 1) < PROCESS_NAMES.length) {
                    statusString += ", performing " + PROCESS_NAMES[subjectState + 1];
                }
            }

            statusString += "</p>";
            $("#trayStatus").html(statusString);


            $("#trayThumbnails").empty();
            for (var i = 0; i <= subjectState; i++) {
                var imgToAdd = $("<img/>");
                imgToAdd.attr("src", makeThumbnailURL(subjectIndex, i));
                imgToAdd.attr("title", SHORT_NAMES[i]); 
                imgToAdd.attr("width", (100 * 1 / PROCESS_NAMES.length) + "%");
                imgToAdd.attr("imgStepNum", i);
                imgToAdd.attr("imgSubjectIndex", selectedSubjectIndex);
                imgToAdd.css("cursor", "pointer");
                
                $(imgToAdd).on("click", function(){
                    $("#trayDialog").load(makeStatsURL($(this).attr("imgSubjectIndex"), $(this).attr("imgStepNum")));
                    //$("#trayDialog").html($(this).attr("imgStepNum"));
                    $("#trayDialog").dialog("option", "width", $(window).width() * 0.60);
                    $("#trayDialog").dialog("option", "height", $(window).height() * 0.35);
                    $("#trayDialog").dialog("open");
                });

                $("#trayThumbnails").append(imgToAdd);
            }
        }


        function setStatus(statusString) {
            $("#status").html(statusString);
        }

        function setMessage(messageString) {
            $("#message").html(messageString);
        }


        function urlExists(testUrl) { // this will return 200 on success, and 0 or negative value on error
            var http = jQuery.ajax({
                type: "HEAD",
                url: testUrl,
                async: false
            });
            return (http.status === 200);
        }

        function makeStatsURL(subjectIndex, state){
            if(state < 0){
                state = 0;
            }
            if(!THUMBNAIL_SUFFIX[state]){
                return null;
            }
            return STATS_RELATIVEPATH + subjects[subjectIndex] + "/" + subjects[subjectIndex] + STATS_SUFFIX[state];
        }


        function makeThumbnailURL(subjectIndex, state) {
            if (state < 0){
                state = 0;
            }
            if (!THUMBNAIL_SUFFIX[state]){
                return null;
            }
            return THUMBNAILS_RELATIVEPATH + subjects[subjectIndex] + "/" + subjects[subjectIndex] + THUMBNAIL_SUFFIX[state];
        }



        function setThumbSize(height){
            for (var subjectIndex = 0; subjectIndex < subjects.length; subjectIndex++) {
                $("#img" + subjectIndex).attr("height", height);
            }
            $("#thumbsize").html(height);
        }

        function setShowStage(stage){
            $("#showstage").html(PROCESS_NAMES[stage]);
        }
        
        function setSubjectCount(n){
            $("#subjectCount").html(n);
        }

        function updateImages(newStates){
            loadSubjTray(selectedSubjectIndex);
            var maxState = $("#slider_showstage").slider("option", "value");
            for (var subjectIndex = 0; subjectIndex < subjects.length; subjectIndex++) {
                {
                    var statePct = 0;
                    var newState = parseInt(newStates[subjectIndex].state);
                    if (newState > 0) {
                        statePct = Math.min(1, newState / (SHORT_NAMES.length - 1));
                    }

                    if (newState != subjectStates[subjectIndex]) {
                        subjectStates[subjectIndex] = newState;
                        
                        document.getElementById("text" + subjectIndex).innerHTML = subjects[subjectIndex] + "<br/>" + SHORT_NAMES[newState];
                        
                        document.getElementById("progress" + subjectIndex).style.width = 100 * statePct + "%";
                    }
                    
                    var stateToShow = Math.min(newState, maxState);
                    var url = makeThumbnailURL(subjectIndex, stateToShow);;
                    if (!url){
                        continue;
                    }
                    if (urlExists(url)) {
                        $("#img" + subjectIndex).attr("src", url);
                    }

                    var showPct = 0;
                    showPct = (stateToShow / (SHORT_NAMES.length - 1)) / statePct;
                    document.getElementById("progressShown" + subjectIndex).style.width = 100 * showPct + "%";
                }
            }
            
        }

        function scanJSON() {
            if (ajaxLock){
                return;
            }

            $.ajax({
                cache: false,
                url: JSON_PATH,
                dataType: "json",
                success: function (json) {
                    ajaxLock = true;

                    if (json) {
                        var statusString = json.status + "<br/>"
                        statusString += "started at: " + json.start_time + "<br/>";
                        statusString += "runtime: " + json.runtime;
                        if (json.subjects) {
                            setStatus(statusString);
                            updateImages(json.subjects);
                        }
                        else {
                            setStatus(statusString + " (no state data available)");
                        }
                    }

                    ajaxLock = false;
                }
            });
        }

        function startTimer() {
            setInterval(scanJSON, 1000);
            setStatus("initializing images");
        }

        $(document).ready(function(){
            
            $(function () {
                $("#slider_thumbsize").slider({
                    slide: function (event, ui) {
                        setThumbSize(ui.value);
                    },
                    animate: "fast", min: 64, max: 512, value: DEFAULT_THUMB_SIZE
                });
            }); 

            $(function () {
                $("#slider_showstage").slider({
                    slide: function (event, ui) {
                        setShowStage(ui.value);
                    },
                    animate: "fast", min:0 , max: PROCESS_NAMES.length - 1, value: DEFAULT_SHOWSTAGE
                });
           });

            $(window).resize(function () {
                var viewportWidth = $(window).width();
                var viewPortHeight = $(window).height();
                var imageport = document.getElementById("images");
                if (imageport)
                    imageport.style.height = (viewPortHeight - 400) + "px";
            });
            
            initPaths();
            initFromJSON();
            
            //Init dialog boxes
            $("#trayDialog").dialog({
                autoOpen: false,
                show: {
                    effect: "fold",
                    duration: 250
                },
                hide: {
                    effect: "fade",
                    duration: 250
                }
            });
            
            

            startTimer();
        });
    </script>
    <!--/////////////////////////////////////////////////////////////////////////////////////////////////////////////-->

</head>


<body>
    <div>
        <div class="roundrect" style="margin-right:px;">
            <center style="font-size:150%">BrainSuite QC System</center>
            <p id="status">initializing</p>
            <div>
                <span>Showing </span>
                <span id="subjectCount">N</span>
                <span> subjects up to </span>
                <span id="showstage"></span>
                <span>at size </span>
                <span id="thumbsize"></span>
                <p />
            </div>
            <div style="width:75%">
                <span>Thumbnail Size</span>
                <div id="slider_thumbsize"></div>
            </div>
            <div style="width:75%">
                <span>Show Stage</span>
                <div id = "slider_showstage"></div>
            </div>
        </div>

        <div id="tray" class="roundrect" style="margin-right:px">
            <div id="trayStatus">
                <!-- Load with loadSubjTray -->
            </div>
            <div id="trayDialog" title="Statistics Report">
                <!-- Update with onclick of each image in subject tray -->
            </div>
            <div id="trayThumbnails">
                <!-- Load with loadSubjTray -->
            </div>
        </div>
        <div id="images" class="roundrect">
            <ul id="gallery">
                <!-- Dynamically init from initFromJSON() -->
            </ul>
        </div> <!-- images frame -->
    </div>
</body>

